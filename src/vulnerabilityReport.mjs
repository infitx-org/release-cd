import * as k8s from '@kubernetes/client-node';
import fs from 'fs';
import path from 'path';

const VULNERABILITY_REPORT_PLURAL = 'vulnerabilitymanifests';
const allureDir = path.resolve('allure-results');
const k8sConfig = new k8s.KubeConfig();
k8sConfig.loadFromDefault();
const k8sApi = k8sConfig.makeApiClient(k8s.CustomObjectsApi);
const group = 'spdx.softwarecomposition.kubescape.io';
const version = 'v1beta1';

async function getAllPolicyReports() {
    const policyReportsRes = await k8sApi.listClusterCustomObject({
        group,
        version,
        plural: VULNERABILITY_REPORT_PLURAL
    });

    const images = policyReportsRes.items.reduce((acc, item) => {
        const image = item.metadata.annotations['kubescape.io/image-tag'];
        return (!acc[image]) ? {
            ...acc, [image]: {
                uid: item.metadata.uid,
                namespace: item.metadata.namespace,
                name: item.metadata.name
            }
        } : acc;
    }, {});

    return Object.entries(images).sort((a, b) => a[0].localeCompare(b[0])).map(([, value]) => value) || [];
}

async function writeAllureResults(policyReports) {
    for (const index in policyReports) {
        const { name, namespace, uid } = policyReports[index];
        console.log(`Processing VulnerabilityReport ${Number(index) + 1} / ${policyReports.length}: ${name}`);
        const manifest = await k8sApi.getNamespacedCustomObject({
            group,
            version,
            plural: VULNERABILITY_REPORT_PLURAL,
            name,
            namespace
        });

        const filename = `${uid}-result.json`;
        const filepath = path.join(allureDir, filename);
        const image = manifest?.metadata?.annotations?.['kubescape.io/image-tag'];
        if (image) fs.writeFileSync(filepath, JSON.stringify({
            uuid: uid,
            name: image,
            titlePath: [
                'kubescape'
            ],
            fullName: image,
            status: 'failed',
            labels: [
                { name: 'package', value: 'kubescape' },
                { name: 'parentSuite', value: 'vulnerability' },
            ],
            stage: 'finished',
            steps: manifest?.spec?.payload?.matches?.map?.(({ artifact, vulnerability }) => ({
                name: `${artifact.name} ${artifact.version}`,
                status: 'failed',
                type: 'step',
                statusDetails: {
                    message: `${vulnerability.severity} => ${vulnerability.description}`,
                    trace: vulnerability.dataSource
                }
            })).sort((a, b) => a.name.localeCompare(b.name))
        }, null, 2))
        // todo handle image not found
    }
};

// Main
async function main() {
    if (!fs.existsSync(allureDir)) fs.mkdirSync(allureDir, { recursive: true });
    writeAllureResults(await getAllPolicyReports());
}

main().catch(err => {
    console.error('Error extracting policy reports:', err);
    process.exit(1);
});
